{
  "name": "Supplements API v2",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "nexus-supplements",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [240, 300],
      "webhookId": "nexus-supplements-v2",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT jsonb_build_object(\n  'supplements', COALESCE((SELECT jsonb_agg(row_to_json(s)) FROM (\n    SELECT id, name, brand, dose_amount, dose_unit, frequency, times_of_day, category, notes, active\n    FROM health.supplement_definitions WHERE active = TRUE ORDER BY category, name\n  ) s), '[]'::jsonb),\n  'summary', jsonb_build_object(\n    'total_supplements', (SELECT COUNT(*) FROM health.supplement_definitions WHERE active = TRUE),\n    'total_doses_today', (SELECT COUNT(*) FROM health.v_todays_supplements),\n    'taken', (SELECT COUNT(*) FILTER (WHERE status = 'taken') FROM health.v_todays_supplements),\n    'skipped', (SELECT COUNT(*) FILTER (WHERE status = 'skipped') FROM health.v_todays_supplements),\n    'pending', (SELECT COUNT(*) FILTER (WHERE status = 'pending') FROM health.v_todays_supplements),\n    'adherence_pct', CASE WHEN (SELECT COUNT(*) FROM health.v_todays_supplements) > 0\n      THEN ROUND((SELECT COUNT(*) FILTER (WHERE status = 'taken') FROM health.v_todays_supplements)::numeric / (SELECT COUNT(*) FROM health.v_todays_supplements) * 100)\n      ELSE NULL END\n  )\n) as payload;",
        "options": {}
      },
      "id": "get-data",
      "name": "Get Data",
      "type": "n8n-nodes-base.postgres",
      "position": [460, 300],
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Nexus DB"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.payload }}"
      },
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [680, 300],
      "typeVersion": 1.1
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{ "node": "Get Data", "type": "main", "index": 0 }]]
    },
    "Get Data": {
      "main": [[{ "node": "Respond", "type": "main", "index": 0 }]]
    }
  },
  "settings": { "executionOrder": "v1" },
  "tags": [{ "name": "nexus" }]
}
