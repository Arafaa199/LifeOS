{
  "name": "Nexus Photo Food Logger",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "nexus-photo-food",
        "options": {
          "allowFileUploads": true,
          "maxFileSize": 10
        }
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "nexus-photo-food"
    },
    {
      "parameters": {
        "operation": "text",
        "messages": {
          "values": [
            {
              "role": "user",
              "content": "={{ \"I'm sending you a photo of food. Please identify what food items are in the image and estimate the nutritional information (calories, protein, carbs, fat). \\n\\nAdditional context from user: \" + ($json.body.context || \"none\") + \"\\n\\nProvide your response in this exact JSON format:\\n{\\n  \\\"food_items\\\": [\\\"item1\\\", \\\"item2\\\"],\\n  \\\"description\\\": \\\"brief description\\\",\\n  \\\"calories\\\": estimated_calories_number,\\n  \\\"protein_g\\\": estimated_protein_number,\\n  \\\"carbs_g\\\": estimated_carbs_number,\\n  \\\"fat_g\\\": estimated_fat_number,\\n  \\\"confidence\\\": \\\"high/medium/low\\\",\\n  \\\"notes\\\": \\\"any important notes or warnings\\\"\\n}\" }}",
              "imageUrl": "={{ \"data:\" + $binary.data.mimeType + \";base64,\" + $binary.data.data }}"
            }
          ]
        },
        "options": {
          "maxTokens": 500,
          "temperature": 0.3
        }
      },
      "name": "Claude Vision Analysis",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1,
      "position": [450, 300],
      "credentials": {
        "anthropicApi": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract JSON from Claude's response\nconst response = $input.item.json.content || $input.item.json.message;\nlet parsed;\n\ntry {\n  // Try to find JSON in response\n  const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    parsed = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('No JSON found in response');\n  }\n} catch (error) {\n  // Fallback - create basic entry\n  parsed = {\n    food_items: ['Unknown food'],\n    description: 'Photo uploaded - manual review needed',\n    calories: 0,\n    protein_g: 0,\n    carbs_g: 0,\n    fat_g: 0,\n    confidence: 'low',\n    notes: 'Failed to parse AI response: ' + error.message\n  };\n}\n\n// Get original request data\nconst body = $('Webhook').item.json.body || {};\nconst source = body.source || 'ios-photo';\nconst context = body.context || null;\n\nreturn {\n  json: {\n    ...parsed,\n    source: source,\n    user_context: context,\n    timestamp: new Date().toISOString(),\n    photo_processed: true\n  }\n};"
      },
      "name": "Parse Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO nutrition.food_log (\n  description,\n  meal_time,\n  calories,\n  protein_g,\n  carbs_g,\n  fat_g,\n  source,\n  metadata,\n  logged_at\n) VALUES (\n  $1, $2, $3, $4, $5, $6, $7, $8, NOW()\n) RETURNING id, logged_at;",
        "options": {
          "queryParameters": "={{ [\n  $json.description,\n  'unknown',\n  $json.calories || 0,\n  $json.protein_g || 0,\n  $json.carbs_g || 0,\n  $json.fat_g || 0,\n  $json.source,\n  JSON.stringify({\n    food_items: $json.food_items,\n    confidence: $json.confidence,\n    notes: $json.notes,\n    user_context: $json.user_context,\n    photo_processed: true\n  })\n] }}"
        }
      },
      "name": "Save to Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [850, 300],
      "credentials": {
        "postgres": {
          "id": "2",
          "name": "Nexus PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  success: true,\n  message: \"Food logged from photo: \" + $('Parse Response').item.json.description,\n  data: {\n    id: $json.id,\n    food_items: $('Parse Response').item.json.food_items,\n    calories: $('Parse Response').item.json.calories,\n    protein: $('Parse Response').item.json.protein_g,\n    carbs: $('Parse Response').item.json.carbs_g,\n    fat: $('Parse Response').item.json.fat_g,\n    confidence: $('Parse Response').item.json.confidence,\n    notes: $('Parse Response').item.json.notes\n  }\n} }}"
      },
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  success: false,\n  message: \"Failed to process photo: \" + $json.error.message,\n  error: $json.error.message\n} }}",
        "options": {
          "responseCode": 500
        }
      },
      "name": "Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [850, 500]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Claude Vision Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude Vision Analysis": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Response": {
      "main": [
        [
          {
            "node": "Save to Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Database": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-01-19T00:00:00.000Z",
  "versionId": "1"
}
