{
  "name": "HealthKit: Batch Webhook",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "healthkit/batch",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "webhook-healthkit-batch",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "healthkit-batch"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json;\nconst clientId = body.client_id || null;\nconst device = body.device || 'unknown';\nconst sourceBundleId = body.source_bundle_id || 'unknown';\n\nconst samples = body.samples || [];\nconst workouts = body.workouts || [];\nconst sleep = body.sleep || [];\n\n// Build batch SQL for samples\nlet samplesSql = '';\nif (samples.length > 0) {\n  const vals = samples.map(s => {\n    const sid = (s.sample_id || '').replace(/'/g, \"''\");\n    const stype = (s.type || s.sample_type || '').replace(/'/g, \"''\");\n    const val = parseFloat(s.value) || 0;\n    const unit = (s.unit || '').replace(/'/g, \"''\");\n    const sd = (s.start_date || '').replace(/'/g, \"''\");\n    const ed = (s.end_date || '').replace(/'/g, \"''\");\n    const sbi = (s.source_bundle_id || sourceBundleId).replace(/'/g, \"''\");\n    const dev = (s.device || device).replace(/'/g, \"''\");\n    return `('${sid}', '${stype}', ${val}, '${unit}', '${sd}'::timestamptz, '${ed}'::timestamptz, '${sbi}', '${dev}', 'ios_healthkit')`;\n  }).join(',\\n');\n  samplesSql = `INSERT INTO raw.healthkit_samples (sample_id, sample_type, value, unit, start_date, end_date, source_bundle_id, device_name, source)\\nVALUES ${vals}\\nON CONFLICT (sample_id, source) DO NOTHING;`;\n}\n\n// Build batch SQL for workouts\nlet workoutsSql = '';\nif (workouts.length > 0) {\n  const vals = workouts.map(w => {\n    const wid = (w.workout_id || '').replace(/'/g, \"''\");\n    const wtype = (w.type || '').replace(/'/g, \"''\");\n    const dur = parseFloat(w.duration_min) || 0;\n    const cal = w.calories != null ? parseFloat(w.calories) : 'NULL';\n    const dist = w.distance_m != null ? parseFloat(w.distance_m) : 'NULL';\n    const sd = (w.start_date || '').replace(/'/g, \"''\");\n    const ed = (w.end_date || '').replace(/'/g, \"''\");\n    const sbi = (w.source_bundle_id || sourceBundleId).replace(/'/g, \"''\");\n    const dev = (w.device || device).replace(/'/g, \"''\");\n    return `('${wid}', '${wtype}', ${dur}, ${cal}, ${dist}, '${sd}'::timestamptz, '${ed}'::timestamptz, '${sbi}', '${dev}', 'ios_healthkit')`;\n  }).join(',\\n');\n  workoutsSql = `INSERT INTO raw.healthkit_workouts (workout_id, type, duration_min, calories, distance_m, start_date, end_date, source_bundle_id, device_name, source)\\nVALUES ${vals}\\nON CONFLICT (workout_id, source) DO NOTHING;`;\n}\n\n// Build batch SQL for sleep\nlet sleepSql = '';\nif (sleep.length > 0) {\n  const vals = sleep.map(sl => {\n    const sid = (sl.sleep_id || '').replace(/'/g, \"''\");\n    const stage = (sl.stage || '').replace(/'/g, \"''\");\n    const sd = (sl.start_date || '').replace(/'/g, \"''\");\n    const ed = (sl.end_date || '').replace(/'/g, \"''\");\n    const sbi = (sl.source_bundle_id || sourceBundleId).replace(/'/g, \"''\");\n    const dev = (sl.device || device).replace(/'/g, \"''\");\n    return `('${sid}', '${stage}', '${sd}'::timestamptz, '${ed}'::timestamptz, '${sbi}', '${dev}', 'ios_healthkit')`;\n  }).join(',\\n');\n  sleepSql = `INSERT INTO raw.healthkit_sleep (sleep_id, stage, start_date, end_date, source_bundle_id, device_name, source)\\nVALUES ${vals}\\nON CONFLICT (sleep_id, source) DO NOTHING;`;\n}\n\nreturn {\n  json: {\n    samplesSql: samplesSql || 'SELECT 1',\n    workoutsSql: workoutsSql || 'SELECT 1',\n    sleepSql: sleepSql || 'SELECT 1',\n    samplesCount: samples.length,\n    workoutsCount: workouts.length,\n    sleepCount: sleep.length\n  }\n};"
      },
      "id": "build-sql",
      "name": "Build SQL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [480, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.samplesSql }}",
        "options": {}
      },
      "id": "insert-samples",
      "name": "Insert Samples",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [700, 200],
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Nexus PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.workoutsSql }}",
        "options": {}
      },
      "id": "insert-workouts",
      "name": "Insert Workouts",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [700, 400],
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Nexus PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.sleepSql }}",
        "options": {}
      },
      "id": "insert-sleep",
      "name": "Insert Sleep",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [700, 600],
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Nexus PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"inserted\": {\n    \"samples\": {{ $('Build SQL').item.json.samplesCount }},\n    \"workouts\": {{ $('Build SQL').item.json.workoutsCount }},\n    \"sleep\": {{ $('Build SQL').item.json.sleepCount }}\n  },\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}",
        "options": {}
      },
      "id": "success-response",
      "name": "Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [920, 400]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Build SQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build SQL": {
      "main": [
        [
          {
            "node": "Insert Samples",
            "type": "main",
            "index": 0
          },
          {
            "node": "Insert Workouts",
            "type": "main",
            "index": 0
          },
          {
            "node": "Insert Sleep",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Samples": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Workouts": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Sleep": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "nexus"
    }
  ]
}
