{
  "name": "Nexus: Food Search",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "nexus-food-search",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook",
      "name": "Food Search Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [240, 300],
      "webhookId": "nexus-food-search",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const query = $input.first().json.query;\nconst q = query.q || '';\nconst barcode = query.barcode || '';\nconst limit = Math.min(parseInt(query.limit) || 10, 50);\n\nif (!q && !barcode) {\n  throw new Error('Either q or barcode parameter is required');\n}\n\nreturn { q, barcode, limit, mode: barcode ? 'barcode' : 'search' };"
      },
      "id": "parse-params",
      "name": "Parse Params",
      "type": "n8n-nodes-base.code",
      "position": [460, 300],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.mode === 'barcode' ? \"SELECT id, name, brand, source::text, calories_per_100g, protein_per_100g, carbs_per_100g, fat_per_100g, fiber_per_100g, serving_size_g, serving_description, data_quality FROM nutrition.foods WHERE barcode = '\" + $json.barcode + \"' ORDER BY data_quality LIMIT 1\" : \"SELECT id, fdc_id, barcode, name, brand, source::text, calories_per_100g, protein_per_100g, carbs_per_100g, fat_per_100g, fiber_per_100g, serving_size_g, serving_description, category, data_quality, similarity(name, '\" + $json.q.replace(/'/g, \"''\") + \"')::real AS relevance FROM nutrition.foods WHERE name % '\" + $json.q.replace(/'/g, \"''\") + \"' OR brand % '\" + $json.q.replace(/'/g, \"''\") + \"' ORDER BY data_quality ASC, similarity(name, '\" + $json.q.replace(/'/g, \"''\") + \"') DESC LIMIT \" + $json.limit }}",
        "options": {}
      },
      "id": "db-query",
      "name": "Query Foods DB",
      "type": "n8n-nodes-base.postgres",
      "position": [680, 300],
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Nexus DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all().map(i => i.json);\nreturn [{ json: { success: true, count: items.length, data: items } }];"
      },
      "id": "format-result",
      "name": "Format Result",
      "type": "n8n-nodes-base.code",
      "position": [900, 300],
      "typeVersion": 2
    }
  ],
  "connections": {
    "Food Search Webhook": {
      "main": [
        [
          {
            "node": "Parse Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Params": {
      "main": [
        [
          {
            "node": "Query Foods DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Foods DB": {
      "main": [
        [
          {
            "node": "Format Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "nexus"
    }
  ]
}
