{
  "id": "xbpqOPgL85BPF8uQ",
  "name": "Nexus - Transactions List Webhook",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "nexus-transactions",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "nexus-transactions"
    },
    {
      "parameters": {
        "jsCode": "const query = $('Webhook').first().json.query || {};\n\nconst limit = Math.min(parseInt(query.limit) || 50, 200);\nconst offset = parseInt(query.offset) || 0;\n\nlet dateFilter = '';\nif (query.start_date) {\n  const sd = query.start_date.replace(/[^0-9\\-T:Z]/g, '');\n  dateFilter += ` AND date >= '${sd}'`;\n}\nif (query.end_date) {\n  const ed = query.end_date.replace(/[^0-9\\-T:Z]/g, '');\n  dateFilter += ` AND date < '${ed}'`;\n}\n\nconst countSql = `SELECT COUNT(*)::int AS total_count FROM finance.transactions WHERE NOT is_quarantined AND NOT is_hidden AND (pairing_role IS NULL OR pairing_role != 'fx_metadata')${dateFilter};`;\n\nconst txnSql = `SELECT t.id, t.date, t.merchant_name, t.amount, t.currency, t.category, t.subcategory, t.is_grocery, t.is_restaurant, t.notes, t.tags, t.source, t.amount_preferred, t.fx_rate_used, t.fx_is_estimate, t.fx_source, t.fx_rate_date FROM finance.transactions t WHERE NOT t.is_quarantined AND NOT t.is_hidden AND (t.pairing_role IS NULL OR t.pairing_role != 'fx_metadata')${dateFilter.replace(/date/g, 't.date')} ORDER BY t.date DESC, t.created_at DESC LIMIT ${limit} OFFSET ${offset};`;\n\nreturn [{ json: { countSql, txnSql, limit, offset } }];"
      },
      "id": "build-queries",
      "name": "Build Queries",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.countSql }}",
        "options": {}
      },
      "id": "count-query",
      "name": "Count Total",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [680, 300],
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Nexus PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('Build Queries').first().json.txnSql }}",
        "options": {}
      },
      "id": "query-transactions",
      "name": "Query Transactions",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [900, 300],
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Nexus PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const totalCount = parseInt($('Count Total').first().json.total_count) || 0;\nconst items = $('Query Transactions').all();\n\nconst transactions = items.map(item => {\n  const t = item.json;\n  return {\n    id: t.id,\n    date: t.date,\n    merchant_name: t.merchant_name || '',\n    amount: parseFloat(t.amount) || 0,\n    currency: t.currency || 'AED',\n    category: t.category || null,\n    subcategory: t.subcategory || null,\n    is_grocery: t.is_grocery || false,\n    is_restaurant: t.is_restaurant || false,\n    notes: t.notes || null,\n    tags: t.tags || null,\n    source: t.source || null,\n    amount_preferred: t.amount_preferred ? parseFloat(t.amount_preferred) : null,\n    fx_rate_used: t.fx_rate_used ? parseFloat(t.fx_rate_used) : null,\n    fx_is_estimate: t.fx_is_estimate || null,\n    fx_source: t.fx_source || null,\n    fx_rate_date: t.fx_rate_date || null\n  };\n});\n\nreturn [{\n  json: {\n    success: true,\n    data: {\n      recent_transactions: transactions,\n      total_count: totalCount\n    }\n  }\n}];"
      },
      "id": "build-response",
      "name": "Build Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "respondWith": "firstIncomingItem",
        "options": {}
      },
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1340, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{ "node": "Build Queries", "type": "main", "index": 0 }]]
    },
    "Build Queries": {
      "main": [[{ "node": "Count Total", "type": "main", "index": 0 }]]
    },
    "Count Total": {
      "main": [[{ "node": "Query Transactions", "type": "main", "index": 0 }]]
    },
    "Query Transactions": {
      "main": [[{ "node": "Build Response", "type": "main", "index": 0 }]]
    },
    "Build Response": {
      "main": [[{ "node": "Respond", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "pinData": {}
}
