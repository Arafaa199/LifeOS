[{"updatedAt":"2026-01-30T23:34:35.000Z","createdAt":"2026-01-29T21:51:18.600Z","id":"eCu831BkYVoh8Hwv","name":"Nexus: WHOOP Direct Sync","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}},"id":"schedule","name":"Every 15 Minutes","type":"n8n-nodes-base.scheduleTrigger","position":[240,300],"typeVersion":1.2},{"parameters":{"url":"https://api.prod.whoop.com/developer/v2/cycle","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","sendQuery":true,"queryParameters":{"parameters":[{"name":"limit","value":"1"}]},"options":{}},"id":"fetch-cycle","name":"Fetch Latest Cycle","type":"n8n-nodes-base.httpRequest","position":[460,300],"typeVersion":4.2,"credentials":{"oAuth2Api":{"id":"whoopOAuth2","name":"WHOOP OAuth2"}}},{"parameters":{"url":"https://api.prod.whoop.com/developer/v2/recovery","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","sendQuery":true,"queryParameters":{"parameters":[{"name":"limit","value":"1"}]},"options":{}},"id":"fetch-recovery","name":"Fetch Latest Recovery","type":"n8n-nodes-base.httpRequest","position":[680,300],"typeVersion":4.2,"credentials":{"oAuth2Api":{"id":"whoopOAuth2","name":"WHOOP OAuth2"}}},{"parameters":{"url":"https://api.prod.whoop.com/developer/v2/activity/sleep","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","sendQuery":true,"queryParameters":{"parameters":[{"name":"limit","value":"1"}]},"options":{}},"id":"fetch-sleep","name":"Fetch Latest Sleep","type":"n8n-nodes-base.httpRequest","position":[900,300],"typeVersion":4.2,"credentials":{"oAuth2Api":{"id":"whoopOAuth2","name":"WHOOP OAuth2"}}},{"parameters":{"jsCode":"// Gather results from sequential API calls\nconst cycleData = $('Fetch Latest Cycle').first().json;\nconst recoveryData = $('Fetch Latest Recovery').first().json;\nconst sleepData = $('Fetch Latest Sleep').first().json;\n\nconst cycle = cycleData.records?.[0];\nconst recovery = recoveryData.records?.[0];\nconst sleep = sleepData.records?.[0];\n\nif (!cycle && !recovery && !sleep) {\n  return [{ json: { skip: true, reason: 'No data from WHOOP API' } }];\n}\n\n// Determine date from cycle start (Dubai timezone)\nconst cycleStart = cycle?.start || recovery?.created_at || sleep?.start;\nconst date = cycleStart ? cycleStart.split('T')[0] : new Date().toISOString().split('T')[0];\n\n// Convert milliseconds to minutes\nconst msToMin = (ms) => ms != null ? Math.round(ms / 60000) : null;\n\n// Build recovery record\nconst recoveryRecord = {\n  date: date,\n  recovery_score: recovery?.score?.recovery_score ?? null,\n  hrv_rmssd: recovery?.score?.hrv_rmssd_milli ?? null,\n  rhr: recovery?.score?.resting_heart_rate ?? null,\n  spo2: recovery?.score?.spo2_percentage ?? null,\n  skin_temp: recovery?.score?.skin_temp_celsius ?? null,\n  sleep_performance: sleep?.score?.sleep_performance_percentage ?? null,\n  score_state: recovery?.score_state ?? 'UNKNOWN',\n  raw_data: JSON.stringify({ cycle, recovery, sleep })\n};\n\n// Build sleep record\nconst sleepRecord = {\n  date: date,\n  sleep_start: sleep?.start ?? null,\n  sleep_end: sleep?.end ?? null,\n  time_in_bed_min: msToMin(sleep?.score?.stage_summary?.total_in_bed_time_milli),\n  awake_min: msToMin(sleep?.score?.stage_summary?.total_awake_time_milli),\n  light_sleep_min: msToMin(sleep?.score?.stage_summary?.total_light_sleep_time_milli),\n  deep_sleep_min: msToMin(sleep?.score?.stage_summary?.total_slow_wave_sleep_time_milli),\n  rem_sleep_min: msToMin(sleep?.score?.stage_summary?.total_rem_sleep_time_milli),\n  sleep_efficiency: sleep?.score?.sleep_efficiency_percentage ?? null,\n  sleep_consistency: sleep?.score?.sleep_consistency_percentage ?? null,\n  sleep_performance: sleep?.score?.sleep_performance_percentage ?? null,\n  sleep_needed_min: msToMin(sleep?.score?.sleep_needed?.baseline_milli),\n  sleep_debt_min: msToMin(sleep?.score?.sleep_needed?.need_from_sleep_debt_milli),\n  cycles: sleep?.score?.stage_summary?.sleep_cycle_count ?? null,\n  disturbances: sleep?.score?.stage_summary?.disturbance_count ?? null,\n  respiratory_rate: sleep?.score?.respiratory_rate ?? null,\n  is_nap: sleep?.nap ?? false,\n  raw_data: JSON.stringify(sleep)\n};\n\n// Build strain record\nconst strainRecord = {\n  date: date,\n  day_strain: cycle?.score?.strain ?? null,\n  avg_hr: cycle?.score?.average_heart_rate ?? null,\n  max_hr: cycle?.score?.max_heart_rate ?? null,\n  calories_total: cycle?.score?.kilojoule ? Math.round(cycle.score.kilojoule / 4.184) : null,\n  score_state: cycle?.score_state ?? 'UNKNOWN',\n  raw_data: JSON.stringify(cycle)\n};\n\nreturn [{\n  json: {\n    skip: false,\n    date: date,\n    recovery: recoveryRecord,\n    sleep: sleepRecord,\n    strain: strainRecord\n  }\n}];"},"id":"transform","name":"Transform WHOOP Data","type":"n8n-nodes-base.code","position":[1120,300],"typeVersion":2},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"not-skip","leftValue":"={{ $json.skip }}","rightValue":false,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"check-data","name":"Has Data?","type":"n8n-nodes-base.if","position":[1340,300],"typeVersion":2},{"parameters":{"operation":"executeQuery","query":"=-- Delete + reinsert to ensure propagation triggers fire\nDELETE FROM health.whoop_recovery WHERE date = '{{ $json.date }}';\nINSERT INTO health.whoop_recovery (\n  date, recovery_score, hrv_rmssd, rhr, spo2, skin_temp, sleep_performance, raw_data\n) VALUES (\n  '{{ $json.date }}',\n  {{ $json.recovery.recovery_score ?? 'NULL' }},\n  {{ $json.recovery.hrv_rmssd ?? 'NULL' }},\n  {{ $json.recovery.rhr ?? 'NULL' }},\n  {{ $json.recovery.spo2 ?? 'NULL' }},\n  {{ $json.recovery.skin_temp ?? 'NULL' }},\n  {{ $json.recovery.sleep_performance ?? 'NULL' }},\n  '{{ $json.recovery.raw_data }}'::jsonb\n)\nRETURNING id, date, recovery_score;","options":{}},"id":"upsert-recovery","name":"Upsert Recovery","type":"n8n-nodes-base.postgres","position":[1560,200],"typeVersion":2.5,"credentials":{"postgres":{"id":"p5cyLWCZ9Db6GiiQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"=-- Delete + reinsert to ensure propagation triggers fire\nDELETE FROM health.whoop_sleep WHERE date = '{{ $json.date }}';\nINSERT INTO health.whoop_sleep (\n  date, sleep_start, sleep_end, time_in_bed_min, awake_min, light_sleep_min, deep_sleep_min, rem_sleep_min,\n  sleep_efficiency, sleep_consistency, sleep_performance, sleep_needed_min, sleep_debt_min,\n  cycles, disturbances, respiratory_rate, raw_data\n) VALUES (\n  '{{ $json.date }}',\n  {{ $json.sleep.sleep_start ? \"'\" + $json.sleep.sleep_start + \"'\" : 'NULL' }},\n  {{ $json.sleep.sleep_end ? \"'\" + $json.sleep.sleep_end + \"'\" : 'NULL' }},\n  {{ $json.sleep.time_in_bed_min ?? 'NULL' }},\n  {{ $json.sleep.awake_min ?? 'NULL' }},\n  {{ $json.sleep.light_sleep_min ?? 'NULL' }},\n  {{ $json.sleep.deep_sleep_min ?? 'NULL' }},\n  {{ $json.sleep.rem_sleep_min ?? 'NULL' }},\n  {{ $json.sleep.sleep_efficiency ?? 'NULL' }},\n  {{ $json.sleep.sleep_consistency ?? 'NULL' }},\n  {{ $json.sleep.sleep_performance ?? 'NULL' }},\n  {{ $json.sleep.sleep_needed_min ?? 'NULL' }},\n  {{ $json.sleep.sleep_debt_min ?? 'NULL' }},\n  {{ $json.sleep.cycles ?? 'NULL' }},\n  {{ $json.sleep.disturbances ?? 'NULL' }},\n  {{ $json.sleep.respiratory_rate ?? 'NULL' }},\n  '{{ $json.sleep.raw_data }}'::jsonb\n)\nRETURNING id, date, sleep_performance;","options":{}},"id":"upsert-sleep","name":"Upsert Sleep","type":"n8n-nodes-base.postgres","position":[1560,400],"typeVersion":2.5,"credentials":{"postgres":{"id":"p5cyLWCZ9Db6GiiQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"=-- Delete + reinsert to ensure propagation triggers fire\nDELETE FROM health.whoop_strain WHERE date = '{{ $json.date }}';\nINSERT INTO health.whoop_strain (\n  date, day_strain, avg_hr, max_hr, calories_total, raw_data\n) VALUES (\n  '{{ $json.date }}',\n  {{ $json.strain.day_strain ?? 'NULL' }},\n  {{ $json.strain.avg_hr ?? 'NULL' }},\n  {{ $json.strain.max_hr ?? 'NULL' }},\n  {{ $json.strain.calories_total ?? 'NULL' }},\n  '{{ $json.strain.raw_data }}'::jsonb\n)\nRETURNING id, date, day_strain;","options":{}},"id":"upsert-strain","name":"Upsert Strain","type":"n8n-nodes-base.postgres","position":[1560,600],"typeVersion":2.5,"credentials":{"postgres":{"id":"p5cyLWCZ9Db6GiiQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT life.refresh_daily_facts('{{ $('Transform WHOOP Data').first().json.date }}', 'whoop_direct_sync') AS result;","options":{}},"id":"refresh-facts","name":"Refresh Daily Facts","type":"n8n-nodes-base.postgres","position":[1780,400],"typeVersion":2.5,"credentials":{"postgres":{"id":"p5cyLWCZ9Db6GiiQ","name":"Postgres account"}}},{"parameters":{},"id":"no-data","name":"No Data","type":"n8n-nodes-base.noOp","position":[1560,800],"typeVersion":1}],"connections":{"Every 15 Minutes":{"main":[[{"node":"Fetch Latest Cycle","type":"main","index":0}]]},"Fetch Latest Cycle":{"main":[[{"node":"Fetch Latest Recovery","type":"main","index":0}]]},"Fetch Latest Recovery":{"main":[[{"node":"Fetch Latest Sleep","type":"main","index":0}]]},"Fetch Latest Sleep":{"main":[[{"node":"Transform WHOOP Data","type":"main","index":0}]]},"Transform WHOOP Data":{"main":[[{"node":"Has Data?","type":"main","index":0}]]},"Has Data?":{"main":[[{"node":"Upsert Recovery","type":"main","index":0},{"node":"Upsert Sleep","type":"main","index":0},{"node":"Upsert Strain","type":"main","index":0}],[{"node":"No Data","type":"main","index":0}]]},"Upsert Recovery":{"main":[[{"node":"Refresh Daily Facts","type":"main","index":0}]]},"Upsert Sleep":{"main":[[{"node":"Refresh Daily Facts","type":"main","index":0}]]},"Upsert Strain":{"main":[[{"node":"Refresh Daily Facts","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Every 15 Minutes":{"recurrenceRules":[]}},"meta":null,"pinData":null,"versionId":"1d2e8fd9-de76-41d8-97e7-7b405172e990","activeVersionId":"1d2e8fd9-de76-41d8-97e7-7b405172e990","versionCounter":8,"triggerCount":1,"tags":[{"updatedAt":"2026-01-20T19:31:35.868Z","createdAt":"2026-01-20T19:31:35.868Z","id":"6m4VSpNzwLl69d8j","name":"whoop"},{"updatedAt":"2026-01-19T18:23:54.387Z","createdAt":"2026-01-19T18:23:54.387Z","id":"pFQTs2nRdgeJiIm0","name":"nexus"}],"shared":[{"updatedAt":"2026-01-29T21:51:18.605Z","createdAt":"2026-01-29T21:51:18.605Z","role":"workflow:owner","workflowId":"eCu831BkYVoh8Hwv","projectId":"22AdcA5nOuNzxaWv","project":{"updatedAt":"2026-01-16T12:45:07.892Z","createdAt":"2026-01-16T12:19:29.617Z","id":"22AdcA5nOuNzxaWv","name":"Ahmed Arafa <arafa.uwl19@gmail.com>","type":"personal","icon":null,"description":null,"creatorId":"6e352323-f0d8-4767-9f6d-163557aaa469"}}]}]