{
  "name": "Receipts List Webhook",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "nexus-receipts",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "nexus-receipts"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  r.id,\n  r.vendor,\n  r.store_location,\n  r.receipt_date,\n  r.total,\n  r.status,\n  r.created_at,\n  COALESCE(json_agg(\n    json_build_object(\n      'id', ri.id,\n      'name', ri.name,\n      'brand', ri.brand,\n      'qty', ri.qty,\n      'unit_price', ri.unit_price,\n      'total', ri.total,\n      'category', ri.category\n    ) ORDER BY ri.id\n  ) FILTER (WHERE ri.id IS NOT NULL), '[]') as items\nFROM finance.receipts r\nLEFT JOIN finance.receipt_items ri ON ri.receipt_id = r.id\nGROUP BY r.id\nORDER BY r.receipt_date DESC NULLS LAST, r.created_at DESC\nLIMIT {{ $json.query.limit || 50 }}",
        "options": {}
      },
      "id": "postgres",
      "name": "Fetch Receipts",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [460, 300],
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Nexus Postgres"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "jsCode": "const receipts = $input.all().map(item => {\n  const data = item.json;\n  return {\n    id: data.id,\n    vendor: data.vendor,\n    storeLocation: data.store_location,\n    receiptDate: data.receipt_date,\n    total: parseFloat(data.total) || 0,\n    status: data.status,\n    createdAt: data.created_at,\n    items: typeof data.items === 'string' ? JSON.parse(data.items) : data.items\n  };\n});\n\nreturn [{ json: { success: true, receipts } }];"
      },
      "id": "format",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [560, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{ "node": "Fetch Receipts", "type": "main", "index": 0 }]]
    },
    "Fetch Receipts": {
      "main": [[{ "node": "Format Response", "type": "main", "index": 0 }]]
    },
    "Format Response": {
      "main": [[{ "node": "Respond to Webhook", "type": "main", "index": 0 }]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  }
}
