# Auditor Planning Mode - 2026-02-01

**Generated:** 2026-02-01 01:20:09
**Tasks:** 6

---

Now I have everything I need. Let me generate the task batch. Here are the tasks to append to `ops/queue.md`:

---

## PLANNED TASKS (Auditor-Generated 2026-02-01)

### TASK-PLAN.1: Fix CalendarViewModel Silent Failure on success:false
Priority: P1
Owner: coder
Status: READY
Lane: safe_auto

**Objective:** When the calendar API returns `{ success: false }`, the user sees an empty calendar with no error indication. Add error feedback so the user knows something went wrong.

**Files to Touch:**
- `ios/Nexus/ViewModels/CalendarViewModel.swift`

**Implementation:**
- In `fetchTodayEvents()` (~line 63): add `errorMessage = "Failed to load calendar events"` in the `else` branch after `events = []`
- In `fetchWeekEvents()` (~line 88): same fix in the equivalent `else` branch

**Verification:**
- [ ] `xcodebuild -scheme Nexus build` succeeds
- [ ] Both `else` branches now set `errorMessage`

**Exit Criteria:**
- [ ] `grep -c 'errorMessage.*Failed' ios/Nexus/ViewModels/CalendarViewModel.swift` returns 2

**Done Means:** When the calendar API returns `success: false`, the user sees an error message instead of a silently empty view.

---

### TASK-PLAN.2: Sanitize SQL Inputs in Calendar Events Webhook
Priority: P1
Owner: coder
Status: READY
Lane: safe_auto

**Objective:** Prevent SQL injection in the calendar-events-webhook by validating date parameters in a Code node before they reach the Postgres node.

**Files to Touch:**
- `backend/n8n-workflows/calendar-events-webhook.json`

**Implementation:**
- Add a Code node between the Webhook trigger and the Postgres node
- Validate `start` and `end` query params match `YYYY-MM-DD` format via regex `/^\d{4}-\d{2}-\d{2}$/`
- If invalid, return `{ success: false, error: "Invalid date format" }` and skip the Postgres node
- Pass validated strings through to the Postgres query

**Verification:**
- [ ] Workflow JSON is valid (parseable with `node -e "JSON.parse(require('fs').readFileSync(...))"`)
- [ ] Code node rejects `start=2026-01-01'; DROP TABLE x; --` (returns error, not query)
- [ ] Code node passes `start=2026-01-28&end=2026-02-01` (valid dates forwarded)

**Exit Criteria:**
- [ ] `grep -c 'YYYY-MM-DD\|\\\\d{4}' backend/n8n-workflows/calendar-events-webhook.json` returns ≥1
- [ ] Workflow contains a Code node with date validation logic

**Done Means:** Calendar events webhook rejects malformed date inputs before they reach SQL execution.

---

### TASK-PLAN.3: Unblock facts.daily_finance — Rewrite Refresh to Use finance.transactions
Priority: P1
Owner: coder
Status: READY
Lane: safe_auto

**Objective:** `facts.daily_finance` has 0 rows because `facts.refresh_daily_finance()` reads from `normalized.transactions` (0 rows). Rewrite it to read from `finance.transactions` (1366 rows) and backfill historical data.

**Files to Touch:**
- `backend/migrations/102_fix_daily_finance_refresh.up.sql`
- `backend/migrations/102_fix_daily_finance_refresh.down.sql`

**Implementation:**
- Rewrite `facts.refresh_daily_finance(target_date)` to SELECT from `finance.transactions` instead of `normalized.transactions`
- Map categories: `category ILIKE '%grocer%'` → `grocery_spent`, etc. (match existing category_map patterns)
- Wire into `life.refresh_all()` so it runs nightly alongside other refreshes
- Backfill all historical dates from `finance.transactions`

**Verification:**
- [ ] `SELECT COUNT(*) FROM facts.daily_finance;` — matches `SELECT COUNT(DISTINCT date) FROM finance.transactions WHERE amount < 0;`
- [ ] `SELECT date, total_spent, transaction_count FROM facts.daily_finance ORDER BY date DESC LIMIT 5;` — totals match `SELECT date, SUM(ABS(amount)) FILTER (WHERE amount < 0), COUNT(*) FROM finance.transactions GROUP BY date ORDER BY date DESC LIMIT 5;`
- [ ] `SELECT * FROM life.refresh_all(1, 'test-102');` — completes without error

**Exit Criteria:**
- [ ] `SELECT COUNT(*) FROM facts.daily_finance;` > 0
- [ ] `facts.refresh_daily_finance(CURRENT_DATE)` executes without error

**Done Means:** `facts.daily_finance` is populated with historical per-category spending data and auto-refreshes nightly.

---

### TASK-PLAN.4: Create GitHub Activity iOS View
Priority: P2
Owner: coder
Status: READY
Lane: safe_auto

**Objective:** The backend sends `github_activity` in the dashboard payload and iOS decodes it (PLAN.4 done), but no view displays it. Create a simple GitHub activity card accessible from the dashboard or a dedicated section.

**Files to Touch:**
- `ios/Nexus/Views/Health/GitHubActivityView.swift` (NEW)
- `ios/Nexus/Views/SettingsView.swift` (add navigation link to new view)

**Implementation:**
- Create `GitHubActivityView.swift`: show summary card (active days, push events, streak), daily activity bar chart (last 14 days), active repos list
- Read from `DashboardPayload.githubActivity` via the existing coordinator/dashboard service
- Add a "GitHub Activity" row in SettingsView → Sync Center section that navigates to this view
- Keep it simple — no new API calls, purely reads from existing dashboard payload data

**Verification:**
- [ ] `xcodebuild -scheme Nexus build` succeeds
- [ ] GitHubActivityView.swift exists and compiles
- [ ] SettingsView contains NavigationLink to GitHubActivityView

**Exit Criteria:**
- [ ] `xcodebuild -scheme Nexus build 2>&1 | grep 'BUILD SUCCEEDED'` returns match
- [ ] `grep 'GitHubActivityView' ios/Nexus/Views/SettingsView.swift` returns match

**Done Means:** User can view GitHub activity summary (streak, daily breakdown, repos) from within the iOS app.

---

### TASK-PLAN.5: Sanitize SQL Inputs in Transaction Update Webhook
Priority: P2
Owner: coder
Status: READY
Lane: needs_approval

**Objective:** The transaction-update-webhook interpolates `merchant_name`, `category`, `notes`, and `id` directly into SQL without sanitization. Add input validation to prevent SQL injection on write operations.

**Files to Touch:**
- `backend/n8n-workflows/transaction-update-webhook.json`
- `backend/n8n-workflows/with-auth/transaction-update-webhook.json`

**Implementation:**
- Add a Code node before the Postgres node that:
  - Validates `id` is a positive integer
  - Escapes single quotes in `merchant_name`, `category`, `notes` (replace `'` with `''`)
  - Validates `amount` is numeric
  - Validates `date` matches `YYYY-MM-DD` format
- Pass sanitized values to the Postgres query node
- Apply same fix to both standard and with-auth versions

**Verification:**
- [ ] Workflow JSON is valid (parseable)
- [ ] Code node escapes `merchant_name = "O'Reilly"` → `"O''Reilly"`
- [ ] Code node rejects non-numeric `id`

**Exit Criteria:**
- [ ] Both workflow JSONs contain a sanitization Code node
- [ ] `grep -c "replace.*'" backend/n8n-workflows/transaction-update-webhook.json` returns ≥1

**Done Means:** Transaction update webhook sanitizes all user inputs before SQL execution, preventing injection attacks on write operations.

---

### TASK-PLAN.6: Wire GitHub Error Status into Feed Status Threshold
Priority: P2
Owner: coder
Status: READY
Lane: safe_auto

**Objective:** GitHub feed shows `error` status (last event Jan 27 — 5 days ago) despite the 24h threshold being set in PLAN.1. This is a legitimate staleness — the GitHub sync n8n workflow may not be running. Investigate and fix the github-sync workflow schedule, or adjust threshold if sync is intentionally infrequent.

**Files to Touch:**
- `backend/n8n-workflows/github-sync.json` (investigate schedule)
- `backend/migrations/103_github_feed_threshold.up.sql` (if threshold adjustment needed)
- `backend/migrations/103_github_feed_threshold.down.sql`

**Implementation:**
- Check github-sync.json — is it scheduled? Is it active in n8n?
- If the workflow runs daily but hasn't fired since Jan 27, document the issue for user to reactivate in n8n
- If GitHub sync is intentionally weekly, adjust `expected_interval` from `24:00:00` to `7 days` so it shows `ok` instead of `error`

**Verification:**
- [ ] `SELECT source, expected_interval, status FROM life.feed_status WHERE source = 'github';` — status is `ok` or `stale` (not `error`)
- [ ] GitHub sync workflow schedule documented

**Exit Criteria:**
- [ ] GitHub feed status is not falsely `error` given actual sync frequency

**Done Means:** GitHub feed status accurately reflects whether data is stale relative to its actual sync schedule.

---

## Planning Rationale

### Why these tasks were chosen

1. **TASK-PLAN.1 (CalendarViewModel Silent Failure)** — Highest impact for lowest effort. 2-line fix directly from auditor finding. Users currently see empty calendar with zero feedback on API failure. This is a UX bug that erodes trust.

2. **TASK-PLAN.2 (Calendar Webhook SQL Sanitization)** — Security fix for read-only endpoint. While blast radius is limited (SELECT only), data exfiltration via UNION injection is possible. Simple Code node addition with date regex validation.

3. **TASK-PLAN.3 (Unblock facts.daily_finance)** — This was BLOCKED in the previous planning cycle because `facts.refresh_daily_finance()` reads from `normalized.transactions` (0 rows). The fix is to rewrite it to read from `finance.transactions` (1366 rows). This unblocks PLAN.6 from the previous cycle (category velocity insights) and enables per-category spending analysis.

4. **TASK-PLAN.4 (GitHub Activity iOS View)** — The backend sends github_activity data, iOS decodes it (done in previous PLAN.4), but no view displays it. This is "last mile" wiring — all the data infrastructure exists, just needs a SwiftUI view. Delivers user-visible value from work already completed.

5. **TASK-PLAN.5 (Transaction Update SQL Sanitization)** — Higher risk than calendar endpoint because this is a WRITE operation. Marked `needs_approval` because it modifies an existing workflow that handles financial data, and both standard and with-auth versions need coordinated changes.

6. **TASK-PLAN.6 (GitHub Feed Status)** — GitHub shows `error` in feed status (5 days stale). Either the sync workflow stopped or the threshold is wrong. Low effort diagnostic + fix that removes a false alarm from the dashboard.

### What was deliberately excluded

- **iOS TodayView modifications** — Frozen. Can't add GitHub/calendar widgets there.
- **Category velocity insights (prev PLAN.6)** — Still blocked until PLAN.3 populates `facts.daily_finance`.
- **Weekly insights email** — Lower priority than security fixes and data wiring.
- **Screen time integration** — Deferred per roadmap (needs App Store).
- **Behavioral/location pipeline** — Requires Home Assistant (external system).
- **New data sources** — Focus is on wiring existing data (GitHub, calendar, finance categories) into user-visible surfaces.
- **HealthKit sync improvements** — Working fine (1187 samples), no action needed.
