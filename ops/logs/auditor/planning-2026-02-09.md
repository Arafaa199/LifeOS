# Auditor Planning Mode - 2026-02-09

**Generated:** 2026-02-09 16:22:45
**Tasks:** 6

---

Now I'll generate the auditor plan output. Here it is:

---

## PLANNED TASKS (Auditor-Generated 2026-02-09)

### TASK-PLAN.1: Fix Nightly Ops Runner — Replace `timeout` with macOS-Compatible Alternative
Priority: P1
Owner: coder
Status: READY
Lane: safe_auto

**Objective:** The nightly ops runner (`ops/nightly.sh`) has been failing with exit 127 for 3+ consecutive days because macOS's launchd environment doesn't have GNU `timeout` in PATH. Fix by replacing `timeout` with a POSIX-compatible alternative so all 4 nightly checks resume running.

**Files to Touch:**
- `ops/nightly.sh`

**Implementation:**
- Replace `timeout "$timeout" bash "$FULL_SCRIPT" $args` on line 72 with a `perl`-based timeout or a shell `( cmd ) & wait` pattern
- Recommended approach: add a `run_with_timeout()` function using `perl -e 'alarm shift; exec @ARGV' "$timeout" bash "$FULL_SCRIPT" $args` (perl is always available on macOS)
- Alternative: use `/usr/bin/timeout` if coreutils is installed, falling back to perl

**Verification:**
- [ ] `bash ops/nightly.sh --dry-run` exits 0 without "command not found" errors
- [ ] `bash ops/nightly.sh` runs all 4 checks (smoke-tests, schema-snapshot, sms-replay, ops-health-probe) and produces `ops/reports/ops-report-$(date +%Y-%m-%d).md` with non-127 exit codes
- [ ] `grep 'exit 127' ops/reports/ops-report-$(date +%Y-%m-%d).md` returns 0 matches

**Exit Criteria:**
- [ ] `bash ops/nightly.sh --dry-run 2>&1 | grep -c 'DRY RUN'` returns 4 (all checks attempted)
- [ ] No exit 127 in any check results

**Done Means:** Nightly ops monitoring resumes after 3+ days of blindness. All checks execute and produce actionable status.

---

### TASK-PLAN.2: Create ops/contracts/ Directory with Endpoint Contract Schemas
Priority: P1
Owner: coder
Status: READY
Lane: safe_auto

**Objective:** `check.sh` iterates `$CONTRACTS_DIR/*.json` for webhook contract validation, but `ops/contracts/` doesn't exist. Without contracts, all 16 webhook endpoint checks silently skip validation. Create contract JSON files for the most critical endpoints so smoke tests actually verify API response shapes.

**Files to Touch:**
- `ops/contracts/nexus-dashboard-today.json` (new)
- `ops/contracts/nexus-budgets.json` (new)
- `ops/contracts/nexus-categories.json` (new)
- `ops/contracts/nexus-recurring.json` (new)
- `ops/contracts/ops-health.json` (new)

**Implementation:**
- Each contract file follows the schema expected by `validate-contract.sh`: `{ "endpoint": "...", "required_keys": [{ "path": ".field", "type": "string|number|array|object|boolean" }] }`
- Dashboard contract: verify `.today_facts`, `.feed_status`, `.daily_insights`, `.schema_version` exist with correct types
- Budgets contract: verify response is array or has `.budgets` key
- Start with 5 most critical contracts (dashboard, budgets, categories, recurring, ops-health)

**Verification:**
- [ ] `ls ops/contracts/*.json | wc -l` returns ≥5
- [ ] `bash ops/lib/validate-contract.sh ops/contracts/nexus-dashboard-today.json -` accepts valid dashboard JSON
- [ ] `bash ops/check.sh 2>&1 | grep -c 'healthy'` returns >0 (contracts pass validation)

**Exit Criteria:**
- [ ] `[ -d ops/contracts ]` returns true
- [ ] `ls ops/contracts/*.json | wc -l` ≥ 5

**Done Means:** Webhook smoke tests validate response schemas instead of silently skipping. Contract violations are caught automatically.

---

### TASK-PLAN.3: Add BJJ to MoreView Navigation
Priority: P1
Owner: coder
Status: READY
Lane: safe_auto

**Objective:** BJJ tracking is fully implemented (BJJView, BJJLogSheet, BJJViewModel, BJJCardView, n8n webhooks, migration 178) but the full BJJ view is only accessible via the dashboard card's NavigationLink. Users can't find it from the More tab — the primary discovery point for all features. Add a BJJ entry to MoreView.

**Files to Touch:**
- `ios/Nexus/Views/MoreView.swift`

**Implementation:**
- Add `NavigationLink(destination: BJJView())` in the "Life Data" section, after "Workouts" (line ~85)
- Icon: `figure.martial.arts` (SF Symbol), color: `.blue`
- Subtitle: "Training log & streaks"

**Verification:**
- [ ] `grep 'BJJView' ios/Nexus/Views/MoreView.swift` returns match
- [ ] `xcodebuild -scheme Nexus build 2>&1 | grep 'BUILD SUCCEEDED'` passes

**Exit Criteria:**
- [ ] `grep -c 'BJJView' ios/Nexus/Views/MoreView.swift` returns ≥1
- [ ] iOS build succeeds

**Done Means:** User can navigate to full BJJ training log from the More tab.

---

### TASK-PLAN.4: Wire BJJ Session Count into Dashboard Payload
Priority: P2
Owner: coder
Status: READY
Lane: safe_auto

**Objective:** The BJJ card on TodayView calls `HealthAPI.fetchBJJStreak()` — a separate API call on every dashboard load. Wire BJJ summary into `dashboard.get_payload()` so the card renders from the existing dashboard fetch without an extra network round-trip.

**Files to Touch:**
- `backend/migrations/179_bjj_dashboard_payload.up.sql`
- `backend/migrations/179_bjj_dashboard_payload.down.sql`
- `ios/Nexus/Models/DashboardPayload.swift`

**Implementation:**
- Add `bjj_summary` key to `dashboard.get_payload()`: `{ current_streak, longest_streak, total_sessions, sessions_this_week, sessions_this_month, last_session_date }`
- Query `health.get_bjj_streaks()` + `MAX(session_date)` from `health.bjj_sessions`
- Add `BJJSummary` Codable struct to DashboardPayload with optional decode
- Schema version bump (current → +1)

**Verification:**
- [ ] `ssh nexus "docker exec nexus-db psql -U nexus -d nexus -c \"SELECT (dashboard.get_payload())->'bjj_summary' IS NOT NULL;\""` returns true
- [ ] `xcodebuild -scheme Nexus build 2>&1 | grep 'BUILD SUCCEEDED'` passes
- [ ] Down migration tested

**Exit Criteria:**
- [ ] Dashboard payload includes `bjj_summary` key
- [ ] iOS DashboardPayload decodes it
- [ ] iOS build succeeds

**Done Means:** BJJ card on TodayView can render from cached dashboard data without extra API calls.

---

### TASK-PLAN.5: Add Supplements Feed Status Trigger
Priority: P2
Owner: coder
Status: READY
Lane: safe_auto

**Objective:** The `supplements` feed shows `unknown` status permanently. The `supplement-log-webhook.json` calls `health.log_supplement_dose()` but no trigger updates `life.feed_status_live`. Add an AFTER INSERT trigger on `health.supplement_log` so feed status transitions from "unknown" to "ok" when the user logs a dose.

**Files to Touch:**
- `backend/migrations/180_supplements_feed_trigger.up.sql`
- `backend/migrations/180_supplements_feed_trigger.down.sql`

**Implementation:**
- Create `health.update_feed_status_supplements()` trigger function (same pattern as screen_time trigger from migration 159)
- Create `trg_supplement_log_feed_status` AFTER INSERT OR UPDATE trigger on `health.supplement_log`
- Upsert into `life.feed_status_live` with source='supplements'

**Verification:**
- [ ] `ssh nexus "docker exec nexus-db psql -U nexus -d nexus -c \"SELECT trigger_name FROM information_schema.triggers WHERE event_object_table = 'supplement_log';\""` returns trigger name
- [ ] Test: insert a row into `health.supplement_log` → `SELECT status FROM life.feed_status WHERE source = 'supplements';` returns 'ok'
- [ ] Down migration drops trigger and function

**Exit Criteria:**
- [ ] `SELECT proname FROM pg_proc WHERE proname = 'update_feed_status_supplements';` returns 1 row
- [ ] Test insert transitions status from 'unknown' to 'ok'

**Done Means:** Supplement adherence tracking properly reflected in system health dashboard.

---

### TASK-PLAN.6: Add BJJ Feed Status Tracking
Priority: P2
Owner: coder
Status: READY
Lane: safe_auto

**Objective:** BJJ sessions are logged via `health.bjj_sessions` (migration 178) but have no feed status entry. Add feed status tracking so the Pipeline Health view shows BJJ data freshness alongside other domains.

**Files to Touch:**
- `backend/migrations/181_bjj_feed_status.up.sql`
- `backend/migrations/181_bjj_feed_status.down.sql`

**Implementation:**
- Insert `bjj` source into `life.feed_status_live` with `expected_interval = '7 days'` (weekly training frequency)
- Create `health.update_feed_status_bjj()` trigger function
- Create `trg_bjj_sessions_feed_status` AFTER INSERT OR UPDATE trigger on `health.bjj_sessions`
- Idempotent: use IF NOT EXISTS / ON CONFLICT patterns

**Verification:**
- [ ] `SELECT source, expected_interval FROM life.feed_status WHERE source = 'bjj';` returns `bjj | 7 days`
- [ ] Test: insert into `health.bjj_sessions` → status transitions to 'ok'
- [ ] Down migration drops trigger, function, and feed entry

**Exit Criteria:**
- [ ] Feed status entry exists for 'bjj'
- [ ] Trigger fires on INSERT to bjj_sessions

**Done Means:** BJJ training frequency visible in Pipeline Health alongside all other data sources.

---

## Planning Rationale

### Why These Tasks Were Chosen

1. **TASK-PLAN.1 (Fix nightly runner)** — **Highest priority.** The ops monitoring infrastructure has been blind for 3+ days (Feb 6-8, all showing exit 127). Root cause: macOS launchd doesn't have GNU `timeout` in PATH. This is a 15-minute fix that restores visibility into all infrastructure checks. Without it, webhook failures, schema drift, and replay regressions go undetected.

2. **TASK-PLAN.2 (Create contracts)** — **Unblocks meaningful monitoring.** Even after PLAN.1 fixes `timeout`, `check.sh` iterates `ops/contracts/*.json` which doesn't exist — so all 16 webhook checks would either skip or fail differently. Creating the 5 most critical contracts means smoke tests actually validate API response shapes. Directly complements PLAN.1.

3. **TASK-PLAN.3 (BJJ in MoreView)** — **Quick win, high discoverability.** BJJ is fully implemented end-to-end (DB, n8n, iOS views) but hidden behind the dashboard card. Every other feature (Music, Supplements, Workouts, Documents, etc.) is accessible from MoreView. This is a 2-line change that makes the feature discoverable.

4. **TASK-PLAN.4 (BJJ in dashboard payload)** — **Performance fix.** Currently BJJCardView on TodayView fires a separate `HealthAPI.fetchBJJStreak()` call on every dashboard load. Wiring it into `dashboard.get_payload()` eliminates the extra round-trip and follows the established pattern (GitHub, Calendar, Reminders, Music all in payload).

5. **TASK-PLAN.5 (Supplements feed trigger)** — **Dashboard cleanliness.** `supplements` shows permanent "unknown" in Pipeline Health. The logging webhook exists and works, but no trigger updates feed_status_live. Same fix pattern used for screen_time (migration 159) and music (migration 157).

6. **TASK-PLAN.6 (BJJ feed status)** — **Completeness.** BJJ is the newest data domain with no feed status tracking. Adding it follows the pattern established for every other domain and ensures the Pipeline Health view is comprehensive.

### What Was Deliberately Excluded

- **Debt/Wishlist views** — Require both backend CRUD endpoints AND new iOS views. Multi-session effort that exceeds single-task scope. Better as a dedicated feature sprint.
- **Apple Watch companion** — New target, significant effort, not aligned with current sprint priorities.
- **Receipt→Nutrition matching improvement** — High effort, needs fuzzy matching research. Not a quick win.
- **Unit test expansion** — Blocked on Xcode target configuration (requires user action in Xcode GUI).
- **Health Score Composite (SUGG-05)** — Interesting but speculative. No user request driving it. Would need product design discussion.
- **Smart Hydration Reminders** — Requires Home Assistant automation + n8n workflow. Cross-system change that's better done in a dedicated session.

### Task Ordering Rationale

1. **PLAN.1 → PLAN.2**: Sequential dependency — fix the runner first, then give it contracts to validate against. Together they restore full monitoring coverage.
2. **PLAN.3**: Independent, iOS-only, 5 minutes. Quick win the coder can ship immediately.
3. **PLAN.4**: Backend + iOS change, medium effort. Reduces network calls on every dashboard load.
4. **PLAN.5 → PLAN.6**: Independent feed status triggers. Both follow established patterns, ~10 minutes each. Clean up the remaining "unknown" entries in Pipeline Health.
