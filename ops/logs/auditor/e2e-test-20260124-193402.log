
=== E2E TEST HARNESS - LifeOS Finance ===
[19:34:02] Test prefix: e2e-test-20260124-193402
[19:34:02] Log file: /Users/rafa/Cyber/Dev/LifeOS-Ops/logs/auditor/e2e-test-20260124-193402.log

=== PHASE 1: Baseline Counts ===
[19:34:03] Initial transactions: 147
[19:34:03] Initial raw_events: 0

=== TEST 1: Valid Income (explicit amount) ===
[19:34:03] Response: {"success":true,"idempotent":false,"transaction_id":152,"raw_event_id":13,"amount":1000,"currency":"AED"}
[19:34:03] ✓ TEST 1 PASSED: New income created

=== TEST 2: Idempotency Check (duplicate) ===
[19:34:04] Response: {"success":true,"idempotent":true,"transaction_id":null,"raw_event_id":14,"amount":1000,"currency":"AED"}
[19:34:04] ✓ TEST 2 PASSED: Duplicate detected correctly

=== TEST 3: Raw Text Parsing ===
[19:34:04] Response: {"success":false,"error":"Invalid amount"}
[19:34:04] ✗ TEST 3 FAILED: Expected success=true, parsed_amount=5000
[19:34:04]   Got success=false, parsed_amount=0

=== TEST 4: Validation (missing client_id) ===
[19:34:04] Response: {"success":false,"error":"client_id is required"}
[19:34:04] ✗ TEST 4 FAILED: Should have rejected missing client_id

=== TEST 5: Validation (invalid amount) ===
[19:34:05] Response: {"success":false,"error":"Invalid amount"}
[19:34:05] ✗ TEST 5 FAILED: Should have rejected negative amount

=== PHASE 2: Database Verification ===
[19:34:05] Checking raw_events statuses...
[19:34:05] Raw events:
             client_id             | validation_status | parsed_amount 
-----------------------------------+-------------------+---------------
 e2e-test-20260124-193402-income-1 | valid             |       1000.00
 e2e-test-20260124-193402-income-1 | duplicate         |       1000.00
(2 rows)
[19:34:06] Status counts: valid=1, duplicate=1, invalid=0
[19:34:06] New transactions created: 1
[19:34:07] New raw_events logged: 2

=== INTEGRITY CHECKS ===
[19:34:07] ✓ No orphan valid events
[19:34:07] ✓ No stuck pending events
[19:34:08] ✓ All invalid events have error messages

=== TEST SUMMARY ===
[19:34:08] Tests passed: 2 / 5
[19:34:08] 
[19:34:08] Database changes:
[19:34:08]   - Transactions: 147 → 148 (+1)
[19:34:08]   - Raw events:   0 → 2 (+2)
[19:34:08]   - Valid:        1
[19:34:08]   - Duplicate:    1
[19:34:08]   - Invalid:      0
[19:34:08] 
[19:34:08] ✗ SOME TESTS FAILED (2/5)
