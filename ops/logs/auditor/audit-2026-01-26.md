# LifeOS End-to-End Audit Report

**Date:** 2026-01-26
**Auditor:** Claude (E2E Reliability Audit)
**Status:** CRITICAL ISSUES FOUND

---

## Executive Summary

1. **All four data feeds are degraded** (whoop: stale, healthkit: error, bank_sms: error, manual: error)
2. **Three launchd services failing** - SMS import (exit 78 - wrong path), Receipt ingest (exit 1 - NULL date), Resolve events (exit 1)
3. **WHOOP → normalized pipeline broken** - Data lands in `health.whoop_recovery` but never propagates to `normalized.daily_recovery`
4. **iOS foreground timeout too aggressive** - 5-second hardcoded timeout causes unnecessary failures
5. **System is trustworthy but not reliable** - TRUST-LOCKIN passed, but pipelines aren't running

---

## Top 10 Gaps (Ranked by Impact)

| Rank | Issue | Impact | Root Cause | Files |
|------|-------|--------|------------|-------|
| **P0** | Launchd SMS import path wrong | No SMS fallback import (only watcher works) | Path `/Users/rafa/Cyber/Dev/LifeOS/...` doesn't exist; should be `.../Projects/LifeOS/...` | `~/Library/LaunchAgents/com.nexus.sms-import.plist` |
| **P0** | Receipt ingest NULL date | All receipt→transaction creation fails | `receipt_ingestion.py:730` doesn't set `date` column when receipt has NULL `receipt_date` | `backend/scripts/receipt-ingest/receipt_ingestion.py` |
| **P0** | WHOOP→normalized broken | Health trends empty, no daily_recovery data | Pipeline writes to legacy `health.whoop_recovery` but normalized layer has 0 rows | n8n workflow or missing sync script |
| **P0** | Feed status all degraded | App shows stale data warnings | Multiple pipeline failures compound | All launchd services + n8n |
| **P1** | 5s foreground timeout | Refresh fails on slow networks | Hardcoded `Task.sleep(5_000_000_000)` | `ios/Nexus/ViewModels/DashboardViewModel.swift:361` |
| **P1** | HealthKit never syncing | Weight/steps not reaching backend | `raw.healthkit_samples` created_at is NULL or very old | iOS sync + webhook |
| **P1** | 30s debounce on foreground | May feel unresponsive on app switch | `foregroundRefreshMinInterval = 30` | `ios/Nexus/ViewModels/DashboardViewModel.swift:136` |
| **P2** | No URLRequest timeout | Potential network hang | URLSession.shared.data(for:) has no timeout | `ios/Nexus/Services/NexusAPI.swift` |
| **P2** | OfflineQueue race | Potential double-submit | `isProcessing` flag checked non-atomically | `ios/Nexus/Services/OfflineQueue.swift` |
| **P2** | Resolve-events failing | Pending events not resolved | Exit code 1, unknown error | `com.nexus.resolve-events` |

---

## Data Contract Map (iOS Screens → DB Objects)

| iOS Screen | Data Source | DB Table/View | Refresh Pattern |
|------------|-------------|---------------|-----------------|
| TodayView (Dashboard) | `DashboardService.fetchDashboard()` | `life.get_daily_summary()` → `life.daily_facts` | Pull-to-refresh + 30s foreground debounce |
| FinanceView | `NexusAPI.fetchFinanceSummary()` | `finance.transactions` | Pull-to-refresh |
| SleepView | `DashboardPayload.health` | `health.whoop_recovery` (broken → normalized) | Same as dashboard |
| MealConfirmationView | `NexusAPI.fetchPendingMealConfirmations()` | `life.v_inferred_meals` | On TodayView appear |
| SettingsView (Sync Status) | `NexusAPI.fetchSyncStatus()` | `ops.v_sync_status` | On appear |

---

## Reliability Checklist

### Launchd Services Status

| Service | Exit Code | Status | Root Cause |
|---------|-----------|--------|------------|
| `com.nexus.sms-watcher` | PID 88165 | ✅ Running | OK |
| `com.nexus.sms-import` | 78 | ❌ Failed | Path mismatch (missing `/Projects/`) |
| `com.lifeos.receipt-ingest` | 1 | ❌ Failed | NULL date violation + connection timeout |
| `com.nexus.resolve-events` | 1 | ❌ Failed | Script error (needs investigation) |
| `com.rafa.claude-coder` | 0 | ✅ Idle | OK (on-demand) |
| `com.claude.code-auditor` | 0 | ✅ Idle | OK (on-demand) |

### Data Pipeline Health

| Pipeline | Source | Target | Status | Evidence |
|----------|--------|--------|--------|----------|
| SMS → Transactions | iMessage | `finance.transactions` | ⚠️ Partial | Watcher works (PID 88165), fallback import broken |
| WHOOP → Daily Facts | Home Assistant | `life.daily_facts` | ✅ Working | 93 rows, last day present |
| WHOOP → Normalized | HA sensor | `normalized.daily_recovery` | ❌ Broken | 0 rows (should have 7+) |
| HealthKit → Raw | iOS App | `raw.healthkit_samples` | ❌ Broken | `feed_status` shows error |
| Receipt → Transactions | Gmail | `finance.transactions` | ❌ Broken | NULL date violation |
| Calendar → Raw | iOS App | `raw.calendar_events` | ⚠️ Unknown | n8n workflow active, needs verification |

### Feed Status (Live Query)

```
source    | last_event_at              | status
----------+----------------------------+--------
whoop     | 2026-01-26 00:00:29        | stale    (>1h since last event)
healthkit |                            | error    (no events ever)
bank_sms  | 2026-01-25 14:02:30        | error    (>24h since last event)
manual    | 2026-01-22 11:51:27        | error    (>24h since last event)
```

---

## Data Integrity Evidence

### Table Row Counts

| Table | Rows | Expected | Status |
|-------|------|----------|--------|
| `finance.transactions` | 256 | 200+ | ✅ OK |
| `life.daily_facts` | 93 | 90+ | ✅ OK |
| `health.whoop_recovery` | 7 | 7+ | ✅ OK (but orphaned) |
| `normalized.daily_recovery` | 0 | 7+ | ❌ EMPTY |
| `raw.bank_sms` | 1 | 100+ | ⚠️ Low (test data only?) |
| `raw.healthkit_samples` | 0 | 100+ | ❌ EMPTY |

### Coverage Truth (Last 10 Days)

```
day        | transactions | meals | gap_status   | explanation
-----------+--------------+-------+--------------+------------------------------------------
2026-01-26 |            0 |     0 | expected_gap | No activity recorded
2026-01-25 |            8 |     0 | gap          | Have transactions but no meals
2026-01-24 |            1 |     0 | gap          | Have transactions but no meals
2026-01-23 |            0 |     1 | gap          | Have meals but no transactions
2026-01-22 |            0 |     0 | expected_gap | No activity recorded
```

### Transaction Flow Evidence

```sql
-- Transaction sources
SELECT source, COUNT(*) FROM finance.transactions GROUP BY source;
-- Result: sms=248, manual=8
```

SMS transactions are flowing (248 via watcher), but raw.bank_sms only has 1 row. This suggests the import script bypasses the raw layer and writes directly to `finance.transactions`. **Not a bug, but worth documenting.**

---

## Minimum Fix Plan (12 Tasks)

### Phase 1: Critical Pipeline Fixes (P0)

1. **FIX-001: Fix SMS import launchd path**
   - Update `~/Library/LaunchAgents/com.nexus.sms-import.plist`
   - Change: `/Users/rafa/Cyber/Dev/LifeOS/` → `/Users/rafa/Cyber/Dev/Projects/LifeOS/`
   - Reload: `launchctl unload && launchctl load`
   - Verify: `launchctl list | grep sms-import` shows exit 0

2. **FIX-002: Fix receipt ingestion NULL date**
   - File: `backend/scripts/receipt-ingest/receipt_ingestion.py:730`
   - Issue: `date` column not set when `receipt_date` is NULL
   - Fix: Default to `receipt_date` or `created_at::date` if NULL
   - Verify: Run `python receipt_ingestion.py --all`, no NULL violations

3. **FIX-003: Wire WHOOP → normalized layer**
   - Investigate: Where does `health.whoop_recovery` get populated?
   - Add: Trigger or n8n step to copy to `normalized.daily_recovery`
   - Verify: `SELECT COUNT(*) FROM normalized.daily_recovery` > 0

4. **FIX-004: Fix resolve-events launchd**
   - Check: `cat ~/Library/LaunchAgents/com.nexus.resolve-events.plist`
   - Run manually: `/opt/homebrew/bin/node /path/to/resolve-raw-events.js`
   - Fix errors and reload

### Phase 2: iOS Reliability Fixes (P1)

5. **FIX-005: Increase foreground timeout to 15s**
   - File: `ios/Nexus/ViewModels/DashboardViewModel.swift:361`
   - Change: `5_000_000_000` → `15_000_000_000`
   - Rationale: 5s too aggressive for cellular networks

6. **FIX-006: Add URLRequest timeout configuration**
   - File: `ios/Nexus/Services/NexusAPI.swift`
   - Add: `request.timeoutInterval = 30` to all URLRequest instances
   - Prevents indefinite hangs

7. **FIX-007: Fix HealthKit sync to backend**
   - Verify: `HealthKitSyncService.swift` is calling webhook
   - Check: n8n webhook `POST /webhook/healthkit/batch` is active
   - Test: Manual sync from Settings, check `raw.healthkit_samples`

### Phase 3: Data Quality Fixes (P2)

8. **FIX-008: Make OfflineQueue processing atomic**
   - File: `ios/Nexus/Services/OfflineQueue.swift`
   - Use: `OSAllocatedUnfairLock` or actor isolation for `isProcessing`

9. **FIX-009: Reduce foreground debounce to 15s**
   - File: `ios/Nexus/ViewModels/DashboardViewModel.swift:136`
   - Change: `foregroundRefreshMinInterval = 30` → `15`
   - Better responsiveness on app switch

10. **FIX-010: Add connection retry to receipt ingestion**
    - File: `backend/scripts/receipt-ingest/receipt_ingestion.py`
    - Add: Retry logic with exponential backoff for connection timeouts
    - Currently fails immediately on network issues

### Phase 4: Observability (P2)

11. **FIX-011: Add feed_status refresh trigger**
    - Create: Trigger on INSERT to raw tables to update `life.feed_status`
    - Currently: Manual update required

12. **FIX-012: Document raw.bank_sms bypass**
    - The SMS import writes directly to `finance.transactions`
    - Document this in state.md as intentional (idempotency via external_id)
    - Or: Add INSERT to raw.bank_sms for audit trail

---

## Verification Checklist (Post-Fix)

```bash
# 1. Launchd services all running
launchctl list | grep -E "nexus|lifeos" | grep -v "^\-.*[1-9]"

# 2. Feed status healthy
ssh nexus "docker exec nexus-db psql -U nexus -d nexus -c \"SELECT source, status FROM life.feed_status;\""
# Expected: All 'ok' or 'healthy'

# 3. Normalized layer populated
ssh nexus "docker exec nexus-db psql -U nexus -d nexus -c \"SELECT COUNT(*) FROM normalized.daily_recovery;\""
# Expected: > 0

# 4. iOS app refresh < 5s on WiFi
# Open app, pull to refresh, observe timing

# 5. HealthKit sync working
# Settings > HealthKit Sync > Sync Now > Check raw.healthkit_samples
```

---

## Conclusion

**Verdict:** SYSTEM NEEDS FIXES BEFORE RELIABLE USE

The TRUST-LOCKIN passed (data is correct when present), but the system is **not reliably collecting data**. Three of four feed sources are in error state, and three launchd jobs are failing.

**Priority Order:**
1. Fix launchd paths (FIX-001, FIX-004) - Immediate
2. Fix receipt NULL date (FIX-002) - Immediate
3. Wire WHOOP→normalized (FIX-003) - Same day
4. iOS timeout fixes (FIX-005, FIX-006) - Next iOS build
5. HealthKit investigation (FIX-007) - After launchd fixed

**Estimated Effort:** 4-6 hours for P0 fixes, 2-3 hours for P1 fixes.

---

*Report generated: 2026-01-26T23:00+04*
