{
  "name": "BJJ Auto-Detect & Log",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 18 * * *"
            }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "Daily 10PM Dubai",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        240,
        300
      ],
      "typeVersion": 1.2,
      "notes": "Runs at 22:00 Dubai time = 18:00 UTC. n8n uses UTC."
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Check if session already exists for today\nSELECT COALESCE(\n  (SELECT json_build_object('id', id, 'session_type', session_type, 'source', source, 'duration_minutes', duration_minutes)\n   FROM health.bjj_sessions\n   WHERE session_date = (NOW() AT TIME ZONE 'Asia/Dubai')::date\n   LIMIT 1),\n  json_build_object('id', NULL)\n) as result;",
        "options": {}
      },
      "id": "check-existing",
      "name": "Check Existing Session",
      "type": "n8n-nodes-base.postgres",
      "position": [
        460,
        300
      ],
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const result = $input.first().json.result;\nconst hasExisting = result && result.id != null;\nreturn [{ json: { hasExisting, existing: result } }];"
      },
      "id": "parse-existing",
      "name": "Parse Existing",
      "type": "n8n-nodes-base.code",
      "position": [
        680,
        300
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "no-existing",
              "leftValue": "={{ $json.hasExisting }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-no-existing",
      "name": "No Existing Session?",
      "type": "n8n-nodes-base.if",
      "position": [
        900,
        300
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Query gym enter/exit events from geofence system\n-- Look for gym exits today with duration >= 20 min\nSELECT\n  le_enter.timestamp AS first_seen,\n  le_exit.timestamp AS last_seen,\n  le_exit.duration_minutes,\n  kl.name AS location_name,\n  kl.category\nFROM core.location_events le_exit\nJOIN core.known_locations kl ON kl.id = le_exit.location_id AND kl.category = 'gym'\nLEFT JOIN LATERAL (\n  SELECT timestamp FROM core.location_events le2\n  WHERE le2.location_id = le_exit.location_id\n    AND le2.event_type = 'enter'\n    AND le2.timestamp < le_exit.timestamp\n  ORDER BY le2.timestamp DESC LIMIT 1\n) le_enter ON true\nWHERE le_exit.event_type = 'exit'\n  AND le_exit.duration_minutes >= 20\n  AND le_exit.timestamp AT TIME ZONE 'Asia/Dubai' >= (CURRENT_DATE AT TIME ZONE 'Asia/Dubai')\nUNION ALL\nSELECT NULL::timestamptz, NULL::timestamptz, NULL::int, NULL, NULL\nORDER BY duration_minutes DESC NULLS LAST\nLIMIT 1;",
        "options": {}
      },
      "id": "query-location",
      "name": "Query Location History",
      "type": "n8n-nodes-base.postgres",
      "position": [
        1120,
        200
      ],
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Get today's Whoop strain as supplementary data\nSELECT date, day_strain, avg_hr, calories_active,\n  (raw_data->'score'->>'kilojoule')::numeric as kilojoules\nFROM health.whoop_strain\nWHERE date = (NOW() AT TIME ZONE 'Asia/Dubai')::date\nUNION ALL\nSELECT NULL::date, NULL::numeric, NULL::int, NULL::int, NULL::numeric\nORDER BY day_strain DESC NULLS LAST\nLIMIT 1;",
        "options": {}
      },
      "id": "query-whoop",
      "name": "Query Whoop Strain",
      "type": "n8n-nodes-base.postgres",
      "position": [
        1120,
        400
      ],
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge location and Whoop strain results\nconst locationData = $('Query Location History').first()?.json || {};\nconst whoopData = $('Query Whoop Strain').first()?.json || {};\n\nconst locationConfirmed = locationData.duration_minutes && locationData.duration_minutes >= 20;\nconst hasWhoop = whoopData.day_strain && whoopData.day_strain > 0;\n\n// Determine session type: default BJJ\nlet sessionType = 'bjj';\n\nlet source = null;\nif (locationConfirmed) {\n  source = 'auto_location';\n}\n\n// Calculate duration and times from location data\nlet durationMinutes = locationData.duration_minutes || 60;\nlet startTime = locationData.first_seen || null;\nlet endTime = locationData.last_seen || null;\n\n// Whoop strain supplements the data but doesn't drive detection\nlet strain = (hasWhoop && whoopData.day_strain > 5) ? whoopData.day_strain : null;\nlet hrAvg = hasWhoop ? whoopData.avg_hr : null;\nlet calories = hasWhoop && whoopData.kilojoules ? Math.round(whoopData.kilojoules / 4.184) : null;\n\nreturn [{\n  json: {\n    locationConfirmed,\n    shouldAutoLog: locationConfirmed,\n    source,\n    sessionType,\n    durationMinutes,\n    strain: strain ? parseFloat(strain) : null,\n    hrAvg,\n    calories,\n    startTime,\n    endTime\n  }\n}];"
      },
      "id": "merge-signals",
      "name": "Merge & Decide",
      "type": "n8n-nodes-base.code",
      "position": [
        1340,
        300
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-auto-log",
              "leftValue": "={{ $json.shouldAutoLog }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-should-log",
      "name": "Auto-Log?",
      "type": "n8n-nodes-base.if",
      "position": [
        1560,
        300
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO health.bjj_sessions (\n  session_date,\n  session_type,\n  duration_minutes,\n  start_time,\n  end_time,\n  strain,\n  hr_avg,\n  calories,\n  source\n) VALUES (\n  (NOW() AT TIME ZONE 'Asia/Dubai')::date,\n  '{{ $json.sessionType }}',\n  {{ $json.durationMinutes }},\n  {{ $json.startTime ? \"'\" + new Date($json.startTime).toISOString().slice(11,19) + \"'::time\" : 'NULL' }},\n  {{ $json.endTime ? \"'\" + new Date($json.endTime).toISOString().slice(11,19) + \"'::time\" : 'NULL' }},\n  {{ $json.strain || 'NULL' }},\n  {{ $json.hrAvg || 'NULL' }},\n  {{ $json.calories || 'NULL' }},\n  '{{ $json.source }}'\n)\nON CONFLICT (session_date) DO UPDATE SET\n  session_type = EXCLUDED.session_type,\n  duration_minutes = EXCLUDED.duration_minutes,\n  start_time = EXCLUDED.start_time,\n  end_time = EXCLUDED.end_time,\n  strain = EXCLUDED.strain,\n  hr_avg = EXCLUDED.hr_avg,\n  calories = EXCLUDED.calories,\n  source = EXCLUDED.source,\n  updated_at = NOW()\nRETURNING *;",
        "options": {}
      },
      "id": "insert-session",
      "name": "Log Session",
      "type": "n8n-nodes-base.postgres",
      "position": [
        1780,
        200
      ],
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "p5cyLWCZ9Db6GiiQ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format confirmation notification\nconst session = $('Log Session').first()?.json || $input.first()?.json;\nconst strain = session.strain ? ', strain ' + parseFloat(session.strain).toFixed(1) : '';\nconst duration = session.duration_minutes || session.durationMinutes || 60;\nconst type = (session.session_type || session.sessionType || 'BJJ').toUpperCase();\n\nreturn [{\n  json: {\n    title: type + ' Session Logged',\n    body: duration + 'min' + strain,\n    data: {\n      type: 'bjj_logged',\n      session_id: session.id\n    }\n  }\n}];"
      },
      "id": "format-confirm-notif",
      "name": "Format Confirmation",
      "type": "n8n-nodes-base.code",
      "position": [
        2000,
        200
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://172.17.0.1:8123/api/services/notify/mobile_app_rafas_iphone",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"title\": \"{{ $json.title }}\",\n  \"message\": \"{{ $json.body }}\",\n  \"data\": {\n    \"push\": {\n      \"sound\": \"default\"\n    }\n  }\n}",
        "options": {}
      },
      "id": "send-confirm-notif",
      "name": "Send Confirmation",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2220,
        200
      ],
      "typeVersion": 4.2,
      "credentials": {
        "httpHeaderAuth": {
          "id": "HA Token",
          "name": "Home Assistant Token"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format 'Did you train?' notification with action buttons\nreturn [{\n  json: {\n    title: 'Did you train today?',\n    body: 'No gym activity detected',\n    data: {\n      type: 'bjj_prompt',\n      actions: [\n        { action: 'BJJ', title: 'BJJ (Gi)' },\n        { action: 'NOGI', title: 'No-Gi' },\n        { action: 'MMA', title: 'MMA' },\n        { action: 'SKIP', title: 'No Training', destructive: true }\n      ]\n    }\n  }\n}];"
      },
      "id": "format-prompt-notif",
      "name": "Format Prompt",
      "type": "n8n-nodes-base.code",
      "position": [
        1780,
        420
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://172.17.0.1:8123/api/services/notify/mobile_app_rafas_iphone",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"title\": \"{{ $json.title }}\",\n  \"message\": \"{{ $json.body }}\",\n  \"data\": {\n    \"actions\": [\n      { \"action\": \"BJJ_LOG_BJJ\", \"title\": \"BJJ (Gi)\" },\n      { \"action\": \"BJJ_LOG_NOGI\", \"title\": \"No-Gi\" },\n      { \"action\": \"BJJ_LOG_MMA\", \"title\": \"MMA\" },\n      { \"action\": \"BJJ_SKIP\", \"title\": \"No Training\", \"destructive\": true }\n    ],\n    \"push\": {\n      \"sound\": \"default\",\n      \"interruption-level\": \"time-sensitive\"\n    }\n  }\n}",
        "options": {}
      },
      "id": "send-prompt-notif",
      "name": "Send Prompt",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2000,
        420
      ],
      "typeVersion": 4.2,
      "credentials": {
        "httpHeaderAuth": {
          "id": "HA Token",
          "name": "Home Assistant Token"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Session already exists - skip\nconst existing = $('Parse Existing').first()?.json?.existing;\nreturn [{\n  json: {\n    skipped: true,\n    reason: 'Session already logged',\n    existing_session: existing\n  }\n}];"
      },
      "id": "skip-existing",
      "name": "Skip (Already Logged)",
      "type": "n8n-nodes-base.code",
      "position": [
        1120,
        500
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "completed"
            }
          ]
        },
        "options": {}
      },
      "id": "done-confirm",
      "name": "Done (Confirmed)",
      "type": "n8n-nodes-base.set",
      "position": [
        2440,
        200
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "prompted"
            }
          ]
        },
        "options": {}
      },
      "id": "done-prompt",
      "name": "Done (Prompted)",
      "type": "n8n-nodes-base.set",
      "position": [
        2220,
        420
      ],
      "typeVersion": 3.4
    }
  ],
  "connections": {
    "Daily 10PM Dubai": {
      "main": [
        [
          {
            "node": "Check Existing Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Existing Session": {
      "main": [
        [
          {
            "node": "Parse Existing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Existing": {
      "main": [
        [
          {
            "node": "No Existing Session?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Existing Session?": {
      "main": [
        [
          {
            "node": "Query Location History",
            "type": "main",
            "index": 0
          },
          {
            "node": "Query Whoop Strain",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip (Already Logged)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Location History": {
      "main": [
        [
          {
            "node": "Merge & Decide",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Whoop Strain": {
      "main": [
        [
          {
            "node": "Merge & Decide",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge & Decide": {
      "main": [
        [
          {
            "node": "Auto-Log?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auto-Log?": {
      "main": [
        [
          {
            "node": "Log Session",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Session": {
      "main": [
        [
          {
            "node": "Format Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Confirmation": {
      "main": [
        [
          {
            "node": "Send Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Confirmation": {
      "main": [
        [
          {
            "node": "Done (Confirmed)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Prompt": {
      "main": [
        [
          {
            "node": "Send Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Prompt": {
      "main": [
        [
          {
            "node": "Done (Prompted)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "nexus"
    }
  ]
}